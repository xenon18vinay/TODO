{% extends 'base.html' %}

{% block content %}
    <!-- New Task Input Form - Enhanced Gemini Style with Time Picker -->
    <form method="POST" class="new-task-form">
    {% csrf_token %}

    <div class="form-input-wrapper">
        {{ form.to_do }}
    </div>

    <div class="time-picker-dropdown" id="timePickerDropdown">
        <label class="time-picker-label">Estimated time to complete</label>

        <div class="time-picker-controls">
            <div class="time-input-group">
                <div class="time-input-wrapper">
                    <span class="time-input-label">Hours</span>
                    <input
                        type="number"
                        class="time-input"
                        id="hours"
                        min="0"
                        max="99"
                        value="0"
                        onchange="updateTimeDisplay()"
                    >
                </div>

                <span class="time-separator">:</span>

                <div class="time-input-wrapper">
                    <span class="time-input-label">Minutes</span>
                    <input
                        type="number"
                        class="time-input"
                        id="minutes"
                        min="0"
                        max="59"
                        value="0"
                        onchange="updateTimeDisplay()"
                    >
                </div>
            </div>

            <button type="button" class="clear-time-btn" onclick="clearTime()">
                Clear
            </button>
        </div>

        <div class="quick-select">
            <button type="button" class="quick-select-btn" onclick="setQuickTime(0, 15)">15 min</button>
            <button type="button" class="quick-select-btn" onclick="setQuickTime(0, 30)">30 min</button>
            <button type="button" class="quick-select-btn" onclick="setQuickTime(1, 0)">1 hour</button>
            <button type="button" class="quick-select-btn" onclick="setQuickTime(2, 0)">2 hours</button>
            <button type="button" class="quick-select-btn" onclick="setQuickTime(4, 0)">4 hours</button>
        </div>
    </div>

    <div class="form-toolbar">
        <div class="form-toolbar-left">
            <button type="button" class="toolbar-btn everyday-toggle-btn" id="everydayToggleBtn">
                <span>Everyday</span>
            </button>

            <button type="button" class="toolbar-btn time-toggle-btn" onclick="toggleTimePicker()">
                <span class="time-icon">‚è±Ô∏è</span>
                <span class="time-text">Set time</span>
            </button>
        </div>

        <div class="form-toolbar-right">
            <button type="submit" class="submit-btn" title="Add task">‚Üë</button>
        </div>
    </div>

    <!-- Hidden inputs for form submission -->
    <input type="hidden" name="is_recurring" id="isRecurringHidden" value="">
    <input type="hidden" name="todo_time" id="todoTimeHidden" value="0">
</form>


    <div class="task-list">
        {% for todo in todo_list %}
            {% ifchanged todo.created_at.date %}
                <div class="date-header">
                    {{ todo.created_at|date:"d M Y" }}
                </div>
            {% endifchanged %}

            <div class="task-item {% if todo.checker %}checked{% endif %}" data-task-id="{{ todo.pk }}">
                <!-- Toggle Checkbox Form -->
                <form method="POST" action="{% url 'toggle_todo' todo.pk %}" class="toggle-form">
                    {% csrf_token %}
                    <label for="todo-{{ todo.pk }}">
                        <input
                            type="checkbox"
                            id="todo-{{ todo.pk }}"
                            name="checker"
                            onchange="this.form.submit()"
                            {% if todo.checker %}checked{% endif %}
                        >
                        <span class="custom-checkbox"></span>
                        <div class="task-content">
                            <span class="task-text">{{ todo.to_do }}</span>
                            <div class="task-meta">
                                <span class="task-time">{{ todo.created_at.time|date:"g:i A" }}</span>
                                {% if todo.todo_time.total_seconds > 0 %}
                                    <span class="task-goal">Goal: <span id="goal-time-{{ todo.pk }}" data-seconds="{{ todo.todo_time.total_seconds }}">{{ todo.todo_time|slice:":8" }}</span></span>
                                {% endif %}
                            </div>
                        </div>
                    </label>
                </form>

                <!-- Circular Timer Container -->
                <div class="circular-timer-container">
                    <div class="circular-timer" data-task-id="{{ todo.pk }}">
                        <label for="stopwatch-{{ todo.pk }}">
                        <div class="timer-content">
                            <span class="stopwatch-time" id="stopwatch-{{ todo.pk }}" data-seconds="{{ todo.timer.total_seconds }}">
                                {{ todo.timer|slice:":8" }}
                            </span>
                            <button class="timer-control-btn start-btn" data-task-id="{{ todo.pk }}" title="Start timer">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                </svg>
                            </button>
                            <button class="timer-control-btn stop-btn" data-task-id="{{ todo.pk }}" style="display:none;" title="Stop timer" form="time-form-{{ todo.pk }}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="6" y="4" width="4" height="16"></rect>
                                    <rect x="14" y="4" width="4" height="16"></rect>
                                </svg>
                            </button>
                        </div></label>
                    </div>
                </div>

                <!-- Hidden Time Form -->
                <form id="time-form-{{ todo.pk }}" class="time-form" method="POST" action="{% url 'time_spend' todo.pk %}" style="display: none;">
                    {% csrf_token %}
                    <input type="hidden" name="duration_in_seconds" class="duration-input">
                </form>

                <!-- Delete Form -->
                <form method="POST" action="{% url 'delete_todo' todo.pk %}" class="delete-form">
                    {% csrf_token %}
                    <button type="submit" aria-label="Delete task">&times;</button>
                </form>
            </div>
        {% empty %}
            <div class="empty-state">
                <p>No tasks yet. Start by adding one above!</p>
            </div>
        {% endfor %}
    </div>

<script>
// ============================================================
// UTILITY FUNCTIONS
// ============================================================

/**
 * Gets CSRF token from cookies for Django POST requests
 */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ============================================================
// EVERYDAY TOGGLE FUNCTIONALITY
// ============================================================

let isEverydayActive = false;
const everydayBtn = document.getElementById('everydayToggleBtn');
const everydayHiddenInput = document.getElementById('isRecurringHidden');

everydayBtn.addEventListener('click', function() {
    isEverydayActive = !isEverydayActive;

    if (isEverydayActive) {
        everydayBtn.classList.add('everyday-active');
        everydayHiddenInput.value = 'on';
    } else {
        everydayBtn.classList.remove('everyday-active');
        everydayHiddenInput.value = '';
    }
});

// ============================================================
// TIME PICKER FUNCTIONALITY
// ============================================================

let isTimePickerActive = false;

function toggleTimePicker() {
    const dropdown = document.getElementById('timePickerDropdown');
    const button = document.querySelector('.time-toggle-btn');

    isTimePickerActive = !isTimePickerActive;

    if (isTimePickerActive) {
        dropdown.classList.add('active');
        button.classList.add('active');
        button.querySelector('.time-text').textContent = 'Hide time';
    } else {
        dropdown.classList.remove('active');
        button.classList.remove('active');
        button.querySelector('.time-text').textContent = 'Set time';
    }
}

function setQuickTime(hours, minutes) {
    document.getElementById('hours').value = hours;
    document.getElementById('minutes').value = minutes;
    updateTimeDisplay();
}

function clearTime() {
    document.getElementById('hours').value = 0;
    document.getElementById('minutes').value = 0;
    updateTimeDisplay();
}

function updateTimeDisplay() {
    const hours = parseInt(document.getElementById('hours').value) || 0;
    const minutes = parseInt(document.getElementById('minutes').value) || 0;

    const totalSeconds = (hours * 3600) + (minutes * 60);

    const hiddenInput = document.getElementById('todoTimeHidden');
    if (hiddenInput) {
        hiddenInput.value = totalSeconds;
    }

    const button = document.querySelector('.time-toggle-btn');
    const timeText = button.querySelector('.time-text');

    if (totalSeconds > 0) {
        let displayText = '';
        if (hours > 0) displayText += `${hours}h `;
        if (minutes > 0) displayText += `${minutes}m`;
        timeText.textContent = displayText.trim();
    } else {
        timeText.textContent = isTimePickerActive ? 'Hide time' : 'Set time';
    }
}

// ============================================================
// TIME FORMATTING UTILITIES
// ============================================================

/**
 * Formats seconds into HH:MM:SS or MM:SS
 */
function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    if (hours > 0) {
        return String(hours).padStart(2, '0') + ':' +
               String(minutes).padStart(2, '0') + ':' +
               String(seconds).padStart(2, '0');
    } else {
        return String(minutes).padStart(2, '0') + ':' +
               String(seconds).padStart(2, '0');
    }
}

function formatAllTimers() {
    document.querySelectorAll('.stopwatch-time').forEach(timer => {
        const seconds = parseInt(timer.dataset.seconds) || 0;
        timer.textContent = formatTime(seconds);
    });

    document.querySelectorAll('[id^="goal-time-"]').forEach(goal => {
        const seconds = parseInt(goal.dataset.seconds) || 0;
        goal.textContent = formatTime(seconds);
    });
}

function parseDuration(durationStr) {
    if (!durationStr || durationStr === "0:00:00" || durationStr === "00:00") return 0;
    const parts = durationStr.split(':').map(Number);
    let milliseconds = 0;
    if (parts.length === 3) {
        milliseconds += parts[0] * 3600000;
        milliseconds += parts[1] * 60000;
        milliseconds += parts[2] * 1000;
    } else if (parts.length === 2) {
        milliseconds += parts[0] * 60000;
        milliseconds += parts[1] * 1000;
    }
    return milliseconds;
}

function parseDurationToSeconds(durationStr) {
    if (!durationStr || durationStr === "0:00:00" || durationStr === "00:00") return 0;
    const parts = durationStr.split(':').map(Number);
    let seconds = 0;
    if (parts.length === 3) {
        seconds += parts[0] * 3600;
        seconds += parts[1] * 60;
        seconds += parts[2];
    } else if (parts.length === 2) {
        seconds += parts[0] * 60;
        seconds += parts[1];
    }
    return seconds;
}

// ============================================================
// üöÄ AJAX HEARTBEAT SYSTEM - THE MAGIC HAPPENS HERE
// ============================================================

/**
 * Main timer state object
 * Now includes heartbeatIntervalId and lastSavedSeconds
 */
let activeTimer = {
    intervalId: null,              // Visual update interval (1 second)
    heartbeatIntervalId: null,     // üÜï Background save interval (15 seconds)
    startTime: null,
    lastSavedSeconds: 0,           // üÜï Track last saved progress
    taskId: null,
    stopwatchElement: null,
    progressRing: null,
    originalTime: 0,
    estimatedTime: 0
};

/**
 * üî• HEARTBEAT FUNCTION - Silently saves progress every 15 seconds
 * This is the core AJAX functionality that runs in the background
 */
async function sendHeartbeat() {
    if (!activeTimer.taskId) {
        console.warn('No active timer to save');
        return;
    }

    // Calculate elapsed time since timer started
    const now = new Date();
    const elapsedMilliseconds = now - activeTimer.startTime;
    const totalSeconds = Math.floor((activeTimer.originalTime + elapsedMilliseconds) / 1000);

    // Calculate only the NEW seconds since last save
    const incrementalSeconds = totalSeconds - activeTimer.lastSavedSeconds;

    // Skip if no new progress (shouldn't happen, but safety check)
    if (incrementalSeconds <= 0) {
        console.log('No new progress to save');
        return;
    }

    // Build the URL for this specific task
    const url = `/timer/${activeTimer.taskId}`;

    // Get CSRF token for Django security
    const csrfToken = getCookie('csrftoken');

    // Create form data (simulates form submission)
    const formData = new FormData();
    formData.append('duration_in_seconds', incrementalSeconds);

    try {
        // üì° Send the AJAX request
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });

        if (response.ok) {
            // Update last saved time on success
            activeTimer.lastSavedSeconds = totalSeconds;

        } else {
        }
    } catch (error) {
        console.error(error);
    }
}

/**
 * Updates the visual timer display every second
 * Runs independently from heartbeat saves
 */
function updateStopwatch() {
    const now = new Date();
    const elapsedMilliseconds = now - activeTimer.startTime;
    const totalMilliseconds = activeTimer.originalTime + elapsedMilliseconds;
    const totalSeconds = Math.floor(totalMilliseconds / 1000);

    // Update time display
    activeTimer.stopwatchElement.textContent = formatTime(totalSeconds);

    // Update progress ring if there's an estimated time
    if (activeTimer.estimatedTime > 0 && activeTimer.progressRing) {
        const progress = Math.min(totalSeconds / activeTimer.estimatedTime, 1);
        const circumference = 2 * Math.PI * 34;
        const offset = circumference - (progress * circumference);
        activeTimer.progressRing.style.strokeDashoffset = offset;
    }

    // Check if stopwatch exceeded estimated time
    const taskItem = document.querySelector(`.task-item[data-task-id="${activeTimer.taskId}"]`);
    if (activeTimer.estimatedTime > 0) {
        if (totalSeconds >= activeTimer.estimatedTime) {
            const circularTimer = taskItem.querySelector('.circular-timer');
            circularTimer.classList.add('exceeded');
        }
    }
}

// ============================================================
// TIMER CONTROL EVENT LISTENERS
// ============================================================

document.addEventListener('click', function(e) {
    // ‚èØÔ∏è START BUTTON CLICKED
    if (e.target.closest('.start-btn')) {
        e.preventDefault();

        if (activeTimer.intervalId) {
            alert('Please stop the active timer first!');
            return;
        }

        const button = e.target.closest('.start-btn');
        const taskId = button.dataset.taskId;
        const taskItem = button.closest('.task-item');
        const circularTimer = taskItem.querySelector('.circular-timer');
        const stopwatchDisplay = taskItem.querySelector('.stopwatch-time');
        const stopButton = taskItem.querySelector('.stop-btn');
        const progressRing = document.getElementById(`progress-ring-${taskId}`);

        const goalElement = document.getElementById(`goal-time-${taskId}`);
        const estimatedTime = goalElement ? parseInt(goalElement.dataset.seconds) : 0;

        // Initialize timer state
        activeTimer.taskId = taskId;
        activeTimer.startTime = new Date();
        activeTimer.stopwatchElement = stopwatchDisplay;
        activeTimer.progressRing = progressRing;
        activeTimer.originalTime = parseDuration(stopwatchDisplay.textContent);
        activeTimer.estimatedTime = estimatedTime;
        activeTimer.lastSavedSeconds = Math.floor(activeTimer.originalTime / 1000);

        // üöÄ START VISUAL UPDATES (every 1 second)
        activeTimer.intervalId = setInterval(updateStopwatch, 1000);

        // üöÄ START BACKGROUND HEARTBEAT (every 15 seconds)
        activeTimer.heartbeatIntervalId = setInterval(sendHeartbeat, 15000);

        // Update UI
        button.style.display = 'none';
        stopButton.style.display = 'flex';
        circularTimer.classList.add('active');
        taskItem.classList.add('timer-active');

    }

    // ‚èπÔ∏è STOP BUTTON CLICKED
    if (e.target.closest('.stop-btn')) {
        e.preventDefault();

        const stopButton = e.target.closest('.stop-btn');
        const taskItem = stopButton.closest('.task-item');
        const circularTimer = taskItem.querySelector('.circular-timer');
        const startButton = taskItem.querySelector('.start-btn');

        // Stop both intervals
        clearInterval(activeTimer.intervalId);
        clearInterval(activeTimer.heartbeatIntervalId);

        // Calculate final elapsed time
        const now = new Date();
        const elapsedMilliseconds = now - activeTimer.startTime;
        const totalSeconds = Math.floor((activeTimer.originalTime + elapsedMilliseconds) / 1000);
        const finalIncrementSeconds = totalSeconds - activeTimer.lastSavedSeconds;

        // Submit final time update
        const form = document.getElementById('time-form-' + activeTimer.taskId);
        const input = form.querySelector('.duration-input');
        input.value = finalIncrementSeconds > 0 ? finalIncrementSeconds : 0;

        // Update UI
        stopButton.style.display = 'none';
        startButton.style.display = 'flex';
        circularTimer.classList.remove('active');
        taskItem.classList.remove('timer-active');

        console.log(`‚èπÔ∏è Timer stopped. Final increment: ${finalIncrementSeconds}s`);

        // Reset timer state
        activeTimer.intervalId = null;
        activeTimer.heartbeatIntervalId = null;
        activeTimer.startTime = null;
        activeTimer.lastSavedSeconds = 0;
        activeTimer.taskId = null;
        activeTimer.stopwatchElement = null;
        activeTimer.progressRing = null;
        activeTimer.originalTime = 0;
        activeTimer.estimatedTime = 0;

        // Submit form
        form.submit();
    }
});

// ============================================================
// INITIALIZATION
// ============================================================

document.addEventListener('DOMContentLoaded', function() {
    updateTimeDisplay();
    formatAllTimers();
});
</script>
{% endblock %}