{% extends 'base.html' %}

{% block content %}
    <!-- Intro Slides Overlay -->
    <div class="intro-overlay" id="introOverlay">
        <div class="intro-slides-container">
            <!-- Slide 1: Welcome -->
            <div class="intro-slide active" data-slide="1">
                <div class="intro-slide-content">
                    <div class="intro-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 11l3 3L22 4"></path>
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                        </svg>
                    </div>
                    <h2 class="intro-title">Welcome to My Tasks</h2>
                    <p class="intro-description">Stay organized and track your time efficiently. Let's show you how to get started in just a few simple steps.</p>
                </div>
            </div>

            <!-- Slide 2: Adding Tasks -->
            <div class="intro-slide" data-slide="2">
                <div class="intro-slide-content">
                    <div class="intro-visual">
                        <div class="demo-form">
                            <div class="demo-input">Add a task...</div>
                            <div class="demo-toolbar">
                                <div class="demo-btn">Everyday</div>
                                <div class="demo-btn">‚è±Ô∏è Set time</div>
                                <div class="demo-add-btn">+</div>
                            </div>
                        </div>
                    </div>
                    <h2 class="intro-title">Create Your Tasks</h2>
                    <p class="intro-description">Type your task, optionally set a time goal, or toggle "Everyday" for recurring tasks. Hit the + button to add it to your list.</p>
                </div>
            </div>

            <!-- Slide 3: Track Time -->
            <div class="intro-slide" data-slide="3">
                <div class="intro-slide-content">
                    <div class="intro-visual">
                        <div class="demo-task">
                            <div class="demo-checkbox"></div>
                            <div class="demo-task-text">
                                <div class="demo-task-name">Complete project</div>
                                <div class="demo-task-meta">Goal: 2:00:00</div>
                            </div>
                            <div class="demo-timer">
                                <span>00:00</span>
                                <div class="demo-play-btn">‚ñ∂</div>
                            </div>
                            <div class="demo-delete-btn">üóëÔ∏è</div>
                        </div>
                    </div>
                    <h2 class="intro-title">Track Your Time</h2>
                    <p class="intro-description">Click the play button to start tracking time on any task. Check the box when complete, or delete tasks you no longer need.</p>
                </div>
            </div>

            <!-- Slide 4: Recurring Tasks -->
            <div class="intro-slide" data-slide="4">
                <div class="intro-slide-content">
                    <div class="intro-visual">
                        <div class="demo-recurring">
                            <div class="demo-recurring-header">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                                </svg>
                                <span>Recurring Tasks</span>
                            </div>
                            <div class="demo-recurring-item">
                                <span>Daily workout</span>
                                <div class="demo-actions">
                                    <div class="demo-action-btn">‚è∞</div>
                                    <div class="demo-action-btn">üóëÔ∏è</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <h2 class="intro-title">Manage Recurring Tasks</h2>
                    <p class="intro-description">Tasks marked as "Everyday" appear here. They'll automatically recreate each day, perfect for daily habits and routines.</p>
                </div>
            </div>

            <!-- Slide Navigation -->
            <div class="intro-navigation">
                <div class="intro-dots">
                    <span class="intro-dot active" data-slide="1"></span>
                    <span class="intro-dot" data-slide="2"></span>
                    <span class="intro-dot" data-slide="3"></span>
                    <span class="intro-dot" data-slide="4"></span>
                </div>
                <div class="intro-buttons">
                    <button class="intro-btn intro-skip" id="introSkip">Skip</button>
                    <button class="intro-btn intro-next" id="introNext">Next</button>
                    <button class="intro-btn intro-done" id="introDone" style="display: none;">Get Started</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Task Input Form - Enhanced Gemini Style with Time Picker -->
    <form method="POST" class="new-task-form">
    {% csrf_token %}

    <div class="form-input-wrapper">
        {{ form.to_do }}
    </div>

    <div class="time-picker-dropdown" id="timePickerDropdown">
        <label class="time-picker-label">Targeted Time For Task</label>

        <div class="time-picker-controls">
            <div class="time-input-group">
                <div class="time-input-wrapper">
                    <span class="time-input-label">Hours</span>
                    <input
                        type="number"
                        class="time-input"
                        id="hours"
                        min="0"
                        max="99"
                        value="0"
                        onchange="updateTimeDisplay()"
                    >
                </div>

                <span class="time-separator">:</span>

                <div class="time-input-wrapper">
                    <span class="time-input-label">Minutes</span>
                    <input
                        type="number"
                        class="time-input"
                        id="minutes"
                        min="0"
                        max="59"
                        value="0"
                        onchange="updateTimeDisplay()"
                    >
                </div>
            </div>

            <button type="button" class="clear-time-btn" onclick="clearTime()">
                Clear
            </button>
        </div>

        <div class="quick-select">
            <button type="button" class="quick-select-btn" onclick="setQuickTime(0, 15)">15 min</button>
            <button type="button" class="quick-select-btn" onclick="setQuickTime(0, 30)">30 min</button>
            <button type="button" class="quick-select-btn" onclick="setQuickTime(1, 0)">1 hour</button>
            <button type="button" class="quick-select-btn" onclick="setQuickTime(2, 0)">2 hours</button>
            <button type="button" class="quick-select-btn" onclick="setQuickTime(4, 0)">4 hours</button>
        </div>
    </div>

    <div class="form-toolbar">
        <div class="form-toolbar-left">
            <button type="button" class="toolbar-btn everyday-toggle-btn" id="everydayToggleBtn">
                <span>Everyday</span>
            </button>

            <button type="button" class="toolbar-btn time-toggle-btn" onclick="toggleTimePicker()">
                <span class="time-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg></span>
                <span class="time-text">Set time</span>
            </button>
        </div>

        <div class="form-toolbar-right">
            <button type="submit" class="submit-btn" title="Add task">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        </div>
    </div>


    <!-- Hidden inputs for form submission -->
    <input type="hidden" name="is_recurring" id="isRecurringHidden" value="">
    <input type="hidden" name="todo_time" id="todoTimeHidden" value="0">
</form>
    <!-- Recurring Tasks Section -->
    <div class="recurring-tasks-section">
        <div class="recurring-tasks-header" id="recurringTasksHeader">
            <div class="recurring-tasks-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                </svg>
                <span>Recurring Tasks</span>
            </div>
            <svg class="toggle-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        </div>
        
        <div class="recurring-tasks-list">
            {% if everyday %}
                {% for element in everyday %}
                    <div class="recurring-task-item" data-task-id="{{ element.pk }}">
                        <div class="recurring-task-content">
                            <span class="recurring-task-name">{{ element.task_name }}</span>
                            {% if element.todo_time.total_seconds > 0 %}
                                <span class="recurring-task-time">Goal: {{ element.todo_time|slice:":8" }}</span>
                            {% endif %}
                        </div>
                        
                        <div class="recurring-task-actions">
                            <button class="recurring-action-btn edit-btn" onclick="toggleRecurringTimePicker({{ element.pk }})" title="Edit time">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                            </button>

                            <form method="POST" action={% url 'delete_recurring' pk=element.pk %} >
                                {% csrf_token %}
                            <button class="recurring-action-btn delete-btn" title="Delete">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                            </form>
                        </div>

                        <!-- Time Picker Dropdown for Recurring Task -->
                        <form method="POST" action={% url 'update_recurring' pk=element.pk %} class="recurring-time-form">
                             {% csrf_token %}

                        <div class="recurring-time-picker-dropdown" id="recurringTimePicker-{{ element.pk }}" style="display: none;">
                            <label class="time-picker-label">Edit Goal Time</label>

                            <div class="time-picker-controls">
                                <div class="time-input-group">
                                    <div class="time-input-wrapper">
                                        <span class="time-input-label">Hours</span>
                                        <input
                                            type="number"
                                            class="time-input"
                                            id="recurring-hours-{{ element.pk }}"
                                            min="0"
                                            max="99"
                                            value="0"
                                            onchange="updateRecurringTimeDisplay({{ element.pk }})"
                                        >
                                    </div>

                                    <span class="time-separator">:</span>

                                    <div class="time-input-wrapper">
                                        <span class="time-input-label">Minutes</span>
                                        <input
                                            type="number"
                                            class="time-input"
                                            id="recurring-minutes-{{ element.pk }}"
                                            min="0"
                                            max="59"
                                            value="0"
                                            onchange="updateRecurringTimeDisplay({{ element.pk }})"
                                        >
                                    </div>
                                </div>

                                <button type="submit" class="clear-time-btn" onclick="clearRecurringTime({{ element.pk }})">
                                    Clear
                                </button>
                            </div>
                                <input type="hidden" name="todo_time" id="recurring-todo-time-{{ element.pk }}" value="0">

                            <div class="quick-select">
                                <button type="button" class="quick-select-btn" onclick="setRecurringQuickTime({{ element.pk }}, 0, 15)">15 min</button>
                                <button type="button" class="quick-select-btn" onclick="setRecurringQuickTime({{ element.pk }}, 0, 30)">30 min</button>
                                <button type="button" class="quick-select-btn" onclick="setRecurringQuickTime({{ element.pk }}, 1, 0)">1 hour</button>
                                <button type="button" class="quick-select-btn" onclick="setRecurringQuickTime({{ element.pk }}, 2, 0)">2 hours</button>
                                <button type="button" class="quick-select-btn" onclick="setRecurringQuickTime({{ element.pk }}, 4, 0)">4 hours</button>
                            </div>



                            <div class="recurring-time-actions">
                                <button type="submit" class="recurring-time-save-btn">
                                    Save
                                </button>
                                <button type="button" class="recurring-time-cancel-btn" onclick="toggleRecurringTimePicker({{ element.pk }})">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </form>
                    </div>
                {% endfor %}
            {% else %}
                <div class="recurring-empty-state">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                    </svg>
                    <p>No recurring tasks set up yet.</p>
                    <span>Use the "Everyday" toggle when adding a task.</span>
                </div>
            {% endif %}
        </div>
    </div>

    {% regroup todo_list by created_at.date as tasks_by_date %}
    
    {% if tasks_by_date %}
        {% for date_group in tasks_by_date %}
            <div class="task-list-container">
                <div class="date-header">
                    {{ date_group.grouper|date:"d M Y" }}
                </div>
                
                <div class="task-list">
                    {% for todo in date_group.list %}
                        <div class="task-item {% if todo.checker %}checked{% endif %}" data-task-id="{{ todo.pk }}">
                            <!-- Toggle Checkbox Form -->
                            <form method="POST" action="{% url 'toggle_todo' todo.pk %}" class="toggle-form">
                                {% csrf_token %}
                                <label for="todo-{{ todo.pk }}">
                                    <input
                                        type="checkbox"
                                        id="todo-{{ todo.pk }}"
                                        name="checker"
                                        onchange="this.form.submit()"
                                        {% if todo.checker %}checked{% endif %}
                                    >
                                    <span class="custom-checkbox"></span>
                                    <div class="task-content">
                                        <span class="task-text">{{ todo.to_do }}</span>
                                        <div class="task-meta">
                                            <span class="task-time">{{ todo.created_at.time|date:"g:i A" }}</span>
                                            {% if todo.todo_time.total_seconds > 0 %}
                                                <span class="task-goal">Goal: <span id="goal-time-{{ todo.pk }}" data-seconds="{{ todo.todo_time.total_seconds }}">{{ todo.todo_time|slice:":8" }}</span></span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </label>
                            </form>

                            <!-- Circular Timer Container -->
                            <div class="circular-timer-container">
                                <div class="circular-timer" data-task-id="{{ todo.pk }}">
                                    <label for="stopwatch-{{ todo.pk }}">
                                    <div class="timer-content">
                                        <span class="stopwatch-time" id="stopwatch-{{ todo.pk }}" data-seconds="{{ todo.timer.total_seconds }}">
                                            {{ todo.timer|slice:":8" }}
                                        </span>
                                        <button class="timer-control-btn start-btn" data-task-id="{{ todo.pk }}" title="Start timer">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                                            </svg>
                                        </button>
                                        <button class="timer-control-btn stop-btn" data-task-id="{{ todo.pk }}" style="display:none;" title="Stop timer" form="time-form-{{ todo.pk }}">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="6" y="4" width="4" height="16"></rect>
                                                <rect x="14" y="4" width="4" height="16"></rect>
                                            </svg>
                                        </button>
                                    </div></label>
                                </div>
                            </div>

                            <!-- Hidden Time Form -->
                            <form id="time-form-{{ todo.pk }}" class="time-form" method="POST" action="{% url 'time_spend' todo.pk %}" style="display: none;">
                                {% csrf_token %}
                                <input type="hidden" name="duration_in_seconds" class="duration-input">
                            </form>

                            <!-- Delete Form -->
                            <form method="POST" action="{% url 'delete_todo' todo.pk %}" class="delete-form">
                            {% csrf_token %}
                            <button type="submit" aria-label="Delete task">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                </form>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="task-list-container">
            <div class="empty-state">
                <div class="empty-state-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 11l3 3L22 4"></path>
                        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                    </svg>
                </div>
                <p class="empty-state-title">No tasks yet</p>
                <p class="empty-state-subtitle">Add a task above. Try "Read book for 30 minutes"</p>
            </div>
        </div>
    {% endif %}

<script>
// ============================================================
// UTILITY FUNCTIONS
// ============================================================

/**
 * Gets CSRF token from cookies for Django POST requests
 */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ============================================================
// EVERYDAY TOGGLE FUNCTIONALITY
// ============================================================

let isEverydayActive = false;
const everydayBtn = document.getElementById('everydayToggleBtn');
const everydayHiddenInput = document.getElementById('isRecurringHidden');

everydayBtn.addEventListener('click', function() {
    isEverydayActive = !isEverydayActive;

    if (isEverydayActive) {
        everydayBtn.classList.add('everyday-active');
        everydayHiddenInput.value = 'on';
    } else {
        everydayBtn.classList.remove('everyday-active');
        everydayHiddenInput.value = '';
    }
});

// ============================================================
// TIME PICKER FUNCTIONALITY
// ============================================================

let isTimePickerActive = false;

function toggleTimePicker() {
    const dropdown = document.getElementById('timePickerDropdown');
    const button = document.querySelector('.time-toggle-btn');

    isTimePickerActive = !isTimePickerActive;

    if (isTimePickerActive) {
        dropdown.classList.add('active');
        button.classList.add('active');
        button.querySelector('.time-text').textContent = 'Hide time';
    } else {
        dropdown.classList.remove('active');
        button.classList.remove('active');
        button.querySelector('.time-text').textContent = 'Set time';
    }
}

function setQuickTime(hours, minutes) {
    document.getElementById('hours').value = hours;
    document.getElementById('minutes').value = minutes;
    updateTimeDisplay();
}

function clearTime() {
    document.getElementById('hours').value = 0;
    document.getElementById('minutes').value = 0;
    updateTimeDisplay();
}

function updateTimeDisplay() {
    const hours = parseInt(document.getElementById('hours').value) || 0;
    const minutes = parseInt(document.getElementById('minutes').value) || 0;

    const totalSeconds = (hours * 3600) + (minutes * 60);

    const hiddenInput = document.getElementById('todoTimeHidden');
    if (hiddenInput) {
        hiddenInput.value = totalSeconds;
    }

    const button = document.querySelector('.time-toggle-btn');
    const timeText = button.querySelector('.time-text');
    const clockContainer = document.getElementById('clockDisplayContainer');
    const clockTime = document.getElementById('clockTime');

    if (totalSeconds > 0) {
        let displayText = '';
        if (hours > 0) displayText += `${hours}h `;
        if (minutes > 0) displayText += `${minutes}m`;
        timeText.textContent = displayText.trim();
        
        // Show clock display with formatted time
        if (clockContainer && clockTime) {
            clockTime.textContent = formatTime(totalSeconds);
            clockContainer.style.display = 'block';
        }
    } else {
        timeText.textContent = isTimePickerActive ? 'Hide time' : 'Set time';
        
        // Hide clock display when time is 0
        if (clockContainer) {
            clockContainer.style.display = 'none';
        }
    }
}

// ============================================================
// TIME FORMATTING UTILITIES
// ============================================================

/**
 * Formats seconds into HH:MM:SS or MM:SS
 */
function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    if (hours > 0) {
        return String(hours).padStart(2, '0') + ':' +
               String(minutes).padStart(2, '0') + ':' +
               String(seconds).padStart(2, '0');
    } else {
        return String(minutes).padStart(2, '0') + ':' +
               String(seconds).padStart(2, '0');
    }
}

function formatAllTimers() {
    document.querySelectorAll('.stopwatch-time').forEach(timer => {
        const seconds = parseInt(timer.dataset.seconds) || 0;
        timer.textContent = formatTime(seconds);
    });

    document.querySelectorAll('[id^="goal-time-"]').forEach(goal => {
        const seconds = parseInt(goal.dataset.seconds) || 0;
        goal.textContent = formatTime(seconds);
    });
}

function parseDuration(durationStr) {
    if (!durationStr || durationStr === "0:00:00" || durationStr === "00:00") return 0;
    const parts = durationStr.split(':').map(Number);
    let milliseconds = 0;
    if (parts.length === 3) {
        milliseconds += parts[0] * 3600000;
        milliseconds += parts[1] * 60000;
        milliseconds += parts[2] * 1000;
    } else if (parts.length === 2) {
        milliseconds += parts[0] * 60000;
        milliseconds += parts[1] * 1000;
    }
    return milliseconds;
}

function parseDurationToSeconds(durationStr) {
    if (!durationStr || durationStr === "0:00:00" || durationStr === "00:00") return 0;
    const parts = durationStr.split(':').map(Number);
    let seconds = 0;
    if (parts.length === 3) {
        seconds += parts[0] * 3600;
        seconds += parts[1] * 60;
        seconds += parts[2];
    } else if (parts.length === 2) {
        seconds += parts[0] * 60;
        seconds += parts[1];
    }
    return seconds;
}

// ============================================================
// üöÄ AJAX HEARTBEAT SYSTEM - THE MAGIC HAPPENS HERE
// ============================================================

/**
 * Main timer state object
 * Now includes heartbeatIntervalId and lastSavedSeconds
 */
let activeTimer = {
    intervalId: null,
    heartbeatIntervalId: null,
    startTime: null,
    lastSavedSeconds: 0,
    taskId: null,
    stopwatchElement: null,
    progressRing: null,
    originalTime: 0,
    estimatedTime: 0
};

/**
 * üî• HEARTBEAT FUNCTION - Silently saves progress every 15 seconds
 * This is the core AJAX functionality that runs in the background
 */
async function sendHeartbeat() {
    if (!activeTimer.taskId) {
        console.warn('No active timer to save');
        return;
    }

    // Calculate elapsed time since timer started
    const now = new Date();
    const elapsedMilliseconds = now - activeTimer.startTime;
    const totalSeconds = Math.floor((activeTimer.originalTime + elapsedMilliseconds) / 1000);

    // Calculate only the NEW seconds since last save
    const incrementalSeconds = totalSeconds - activeTimer.lastSavedSeconds;

    // Skip if no new progress (shouldn't happen, but safety check)
    if (incrementalSeconds <= 0) {
        console.log('No new progress to save');
        return;
    }

    // Build the URL for this specific task
    const url = `/timer/${activeTimer.taskId}`;

    // Get CSRF token for Django security
    const csrfToken = getCookie('csrftoken');

    // Create form data (simulates form submission)
    const formData = new FormData();
    formData.append('duration_in_seconds', incrementalSeconds);

    try {
        // üì° Send the AJAX request
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });

        if (response.ok) {
            // Update last saved time on success
            activeTimer.lastSavedSeconds = totalSeconds;

        } else {
        }
    } catch (error) {
        console.error(error);
    }
}

/**
 * Updates the visual timer display every second
 * Runs independently from heartbeat saves
 */
function updateStopwatch() {
    const now = new Date();
    const elapsedMilliseconds = now - activeTimer.startTime;
    const totalMilliseconds = activeTimer.originalTime + elapsedMilliseconds;
    const totalSeconds = Math.floor(totalMilliseconds / 1000);

    // Update time display
    activeTimer.stopwatchElement.textContent = formatTime(totalSeconds);

    // Update progress ring if there's an estimated time
    if (activeTimer.estimatedTime > 0 && activeTimer.progressRing) {
        const progress = Math.min(totalSeconds / activeTimer.estimatedTime, 1);
        const circumference = 2 * Math.PI * 34;
        const offset = circumference - (progress * circumference);
        activeTimer.progressRing.style.strokeDashoffset = offset;
    }

    // Check if stopwatch exceeded estimated time
    const taskItem = document.querySelector(`.task-item[data-task-id="${activeTimer.taskId}"]`);
    if (activeTimer.estimatedTime > 0) {
        if (totalSeconds >= activeTimer.estimatedTime) {
            const circularTimer = taskItem.querySelector('.circular-timer');
            circularTimer.classList.add('exceeded');
        }
    }
}

// ============================================================
// TIMER CONTROL EVENT LISTENERS
// ============================================================

document.addEventListener('click', function(e) {
    // ‚èØÔ∏è START BUTTON CLICKED
    if (e.target.closest('.start-btn')) {
        e.preventDefault();

        if (activeTimer.intervalId) {
            alert('Please stop the active timer first!');
            return;
        }

        const button = e.target.closest('.start-btn');
        const taskId = button.dataset.taskId;
        const taskItem = button.closest('.task-item');
        const circularTimer = taskItem.querySelector('.circular-timer');
        const stopwatchDisplay = taskItem.querySelector('.stopwatch-time');
        const stopButton = taskItem.querySelector('.stop-btn');
        const progressRing = document.getElementById(`progress-ring-${taskId}`);

        const goalElement = document.getElementById(`goal-time-${taskId}`);
        const estimatedTime = goalElement ? parseInt(goalElement.dataset.seconds) : 0;

        // Initialize timer state
        activeTimer.taskId = taskId;
        activeTimer.startTime = new Date();
        activeTimer.stopwatchElement = stopwatchDisplay;
        activeTimer.progressRing = progressRing;
        activeTimer.originalTime = parseDuration(stopwatchDisplay.textContent);
        activeTimer.estimatedTime = estimatedTime;
        activeTimer.lastSavedSeconds = Math.floor(activeTimer.originalTime / 1000);

        // üöÄ START VISUAL UPDATES (every 1 second)
        activeTimer.intervalId = setInterval(updateStopwatch, 1000);

        // üöÄ START BACKGROUND HEARTBEAT (every 15 seconds)
        activeTimer.heartbeatIntervalId = setInterval(sendHeartbeat, 15000);

        // Update UI
        button.style.display = 'none';
        stopButton.style.display = 'flex';
        circularTimer.classList.add('active');
        taskItem.classList.add('timer-active');

    }

    // ‚èπÔ∏è STOP BUTTON CLICKED
    if (e.target.closest('.stop-btn')) {
        e.preventDefault();

        const stopButton = e.target.closest('.stop-btn');
        const taskItem = stopButton.closest('.task-item');
        const circularTimer = taskItem.querySelector('.circular-timer');
        const startButton = taskItem.querySelector('.start-btn');

        // Stop both intervals
        clearInterval(activeTimer.intervalId);
        clearInterval(activeTimer.heartbeatIntervalId);

        // Calculate final elapsed time
        const now = new Date();
        const elapsedMilliseconds = now - activeTimer.startTime;
        const totalSeconds = Math.floor((activeTimer.originalTime + elapsedMilliseconds) / 1000);
        const finalIncrementSeconds = totalSeconds - activeTimer.lastSavedSeconds;

        // Submit final time update
        const form = document.getElementById('time-form-' + activeTimer.taskId);
        const input = form.querySelector('.duration-input');
        input.value = finalIncrementSeconds > 0 ? finalIncrementSeconds : 0;

        // Update UI
        stopButton.style.display = 'none';
        startButton.style.display = 'flex';
        circularTimer.classList.remove('active');
        taskItem.classList.remove('timer-active');

        console.log(`‚èπÔ∏è Timer stopped. Final increment: ${finalIncrementSeconds}s`);

        // Reset timer state
        activeTimer.intervalId = null;
        activeTimer.heartbeatIntervalId = null;
        activeTimer.startTime = null;
        activeTimer.lastSavedSeconds = 0;
        activeTimer.taskId = null;
        activeTimer.stopwatchElement = null;
        activeTimer.progressRing = null;
        activeTimer.originalTime = 0;
        activeTimer.estimatedTime = 0;

        // Submit form
        form.submit();
    }
});

// ============================================================
// RECURRING TASKS TOGGLE
// ============================================================

// Initialize collapsed state from localStorage or default to expanded on desktop, collapsed on mobile
let isRecurringExpanded = localStorage.getItem('recurringTasksExpanded');
if (isRecurringExpanded === null) {
    // Default: expanded on desktop, collapsed on mobile
    isRecurringExpanded = window.innerWidth >= 768 ? 'true' : 'false';
} else {
    isRecurringExpanded = isRecurringExpanded;
}

function toggleRecurringTasks() {
    const section = document.querySelector('.recurring-tasks-section');
    const list = document.querySelector('.recurring-tasks-list');
    const arrow = document.querySelector('.toggle-arrow');
    
    if (isRecurringExpanded === 'true') {
        // Collapse
        section.classList.add('collapsed');
        list.style.display = 'none';
        arrow.style.transform = 'rotate(-90deg)';
        isRecurringExpanded = 'false';
    } else {
        // Expand
        section.classList.remove('collapsed');
        list.style.display = 'block';
        arrow.style.transform = 'rotate(0deg)';
        isRecurringExpanded = 'true';
    }
    
    localStorage.setItem('recurringTasksExpanded', isRecurringExpanded);
}

// ============================================================
// INITIALIZATION
// ============================================================

document.addEventListener('DOMContentLoaded', function() {
    updateTimeDisplay();
    formatAllTimers();
    
    // Set initial state for recurring tasks
    const section = document.querySelector('.recurring-tasks-section');
    const list = document.querySelector('.recurring-tasks-list');
    const arrow = document.querySelector('.toggle-arrow');
    
    if (section && list && arrow) {
        if (isRecurringExpanded === 'false') {
            section.classList.add('collapsed');
            list.style.display = 'none';
            arrow.style.transform = 'rotate(-90deg)';
        } else {
            section.classList.remove('collapsed');
            list.style.display = 'block';
            arrow.style.transform = 'rotate(0deg)';
        }
        
        // Add click event to header
        const header = document.getElementById('recurringTasksHeader');
        if (header) {
            header.style.cursor = 'pointer';
            header.addEventListener('click', toggleRecurringTasks);
        }
    }
});

// ============================================================
// RECURRING TASK TIME PICKER FUNCTIONS
// ============================================================

function toggleRecurringTimePicker(taskId) {
    const dropdown = document.getElementById(`recurringTimePicker-${taskId}`);
    const isVisible = dropdown.style.display === 'block';
    
    // Close all other open time pickers
    document.querySelectorAll('.recurring-time-picker-dropdown').forEach(picker => {
        picker.style.display = 'none';
    });
    
    if (!isVisible) {
        dropdown.style.display = 'block';
        // Load current time if exists
        loadCurrentRecurringTime(taskId);
    } else {
        dropdown.style.display = 'none';
    }
}

function loadCurrentRecurringTime(taskId) {
    // Get the task item
    const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
    if (!taskItem) return;
    
    // Try to find existing goal time
    const goalElement = taskItem.querySelector('.recurring-task-time');
    if (goalElement) {
        const timeText = goalElement.textContent.replace('Goal:', '').trim();
        const seconds = parseDurationToSeconds(timeText);
        
        if (seconds > 0) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            document.getElementById(`recurring-hours-${taskId}`).value = hours;
            document.getElementById(`recurring-minutes-${taskId}`).value = minutes;
            updateRecurringTimeDisplay(taskId);
        }
    }
}

function setRecurringQuickTime(taskId, hours, minutes) {
    document.getElementById(`recurring-hours-${taskId}`).value = hours;
    document.getElementById(`recurring-minutes-${taskId}`).value = minutes;
    updateRecurringTimeDisplay(taskId);
}

function clearRecurringTime(taskId) {
    document.getElementById(`recurring-hours-${taskId}`).value = 0;
    document.getElementById(`recurring-minutes-${taskId}`).value = 0;
    updateRecurringTimeDisplay(taskId);
}


function updateRecurringTimeDisplay(taskId) {
    const hours = parseInt(document.getElementById(`recurring-hours-${taskId}`).value) || 0;
    const minutes = parseInt(document.getElementById(`recurring-minutes-${taskId}`).value) || 0;
    const totalSeconds = (hours * 3600) + (minutes * 60);

    // Update the hidden input with total seconds
    const hiddenInput = document.getElementById(`recurring-todo-time-${taskId}`);
    if (hiddenInput) {
        hiddenInput.value = totalSeconds;
    }

    const clockContainer = document.getElementById(`recurringClockDisplay-${taskId}`);
    const clockTime = document.getElementById(`recurringClockTime-${taskId}`);

    if (totalSeconds > 0 && clockContainer && clockTime) {
        clockTime.textContent = formatTime(totalSeconds);
        clockContainer.style.display = 'block';
    } else if (clockContainer) {
        clockContainer.style.display = 'none';
    }
}

// ============================================================
// INTRO SLIDES FUNCTIONALITY
// ============================================================

let currentSlide = 1;
const totalSlides = 4;

function showSlide(slideNumber) {
    // Hide all slides
    document.querySelectorAll('.intro-slide').forEach(slide => {
        slide.classList.remove('active');
    });
    
    // Show current slide
    const targetSlide = document.querySelector(`.intro-slide[data-slide="${slideNumber}"]`);
    if (targetSlide) {
        targetSlide.classList.add('active');
    }
    
    // Update dots
    document.querySelectorAll('.intro-dot').forEach(dot => {
        dot.classList.remove('active');
    });
    const targetDot = document.querySelector(`.intro-dot[data-slide="${slideNumber}"]`);
    if (targetDot) {
        targetDot.classList.add('active');
    }
    
    // Update buttons
    const nextBtn = document.getElementById('introNext');
    const doneBtn = document.getElementById('introDone');
    
    if (slideNumber === totalSlides) {
        nextBtn.style.display = 'none';
        doneBtn.style.display = 'block';
    } else {
        nextBtn.style.display = 'block';
        doneBtn.style.display = 'none';
    }
}

function closeIntro() {
    const overlay = document.getElementById('introOverlay');
    overlay.classList.add('hidden');
    // Mark intro as completed in localStorage
    localStorage.setItem('hasVisitedBefore', 'true');
}

// Check if this is first visit
// If 'hasVisitedBefore' doesn't exist in localStorage, show intro
const hasVisited = localStorage.getItem('hasVisitedBefore');

if (!hasVisited && document.getElementById('introOverlay')) {
    // First time visitor - show intro
    document.getElementById('introOverlay').classList.remove('hidden');
} else if (document.getElementById('introOverlay')) {
    // Returning visitor - hide intro
    document.getElementById('introOverlay').classList.add('hidden');
}

// Next button
const nextBtn = document.getElementById('introNext');
if (nextBtn) {
    nextBtn.addEventListener('click', () => {
        if (currentSlide < totalSlides) {
            currentSlide++;
            showSlide(currentSlide);
        }
    });
}

// Done button
const doneBtn = document.getElementById('introDone');
if (doneBtn) {
    doneBtn.addEventListener('click', () => {
        closeIntro();
    });
}

// Skip button
const skipBtn = document.getElementById('introSkip');
if (skipBtn) {
    skipBtn.addEventListener('click', () => {
        closeIntro();
    });
}

// Dot navigation
document.querySelectorAll('.intro-dot').forEach(dot => {
    dot.addEventListener('click', () => {
        const slideNum = parseInt(dot.getAttribute('data-slide'));
        currentSlide = slideNum;
        showSlide(currentSlide);
    });
});

</script>
{% endblock %}